name: Swift
on:
      push:
        branches: [main]
jobs: 
      build:
        runs-on: [macos-latest]
        env: 
          XC_VERSION: ${{ '12.1.0' }}
          XC_PROJECT: ${{ 'GitAction/GitAction.xcworkspace' }}
          XC_SCHEME: ${{ 'GitAction' }}

        steps:  
        - uses: actions/checkout@v2
          
        - name: Install Dependencies
          working-directory: ./GitAction
          run: pod install --repo-update
          shell: bash
          
        - name: Select latest Xcode 
          run: "sudo xcode-select -s /Applications/Xcode_$XC_VERSION.app"  
          
        - name: Run Unit and UI Tests
          run: /usr/bin/xcodebuild test -workspace "$XC_PROJECT" -scheme "$XC_SCHEME" -destination 'platform=iOS Simulator,name=iPhone 11'

        - name: If Fail
          uses: actions/github-script@0.2.0
          with:
            github-token: ${{github.token}}
            script: |
              const ref = "${{github.ref}}"
              const pull_number = Number(ref.split("/")[2])
              await github.pulls.createReview({
                ...context.repo,
                pull_number,
                body:"테스트를 통과하지 못했습니다.",
                event: "REQUEST_CHANGES"
              })
              await github.pulls.update({
                ...context.repo,
                pull_number,
                state: "closed"
              })
          if: failure()
